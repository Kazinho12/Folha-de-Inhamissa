<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed | Folha de Inhamissa</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cor-fundo: #000000;      /* Preto (noturno) */
            --cor-texto: #FFFFFF;      /* Branco (noturno) */
            --cor-destaque: #FFD700;   /* Amarelo */
            --cor-hover: #FFC107;      /* Amarelo escuro */
            --cor-cinza: #6B7280;     /* Cinza para elementos secundários */
            --cor-branco: #FFFFFF;     /* Branco para cards (noturno) */
            --cor-link: #FFD700;       /* Amarelo para links */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* App Bar Superior */
        .app-bar {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: var(--cor-fundo);
            box-shadow: 0 1px 3px rgba(255, 215, 0, 0.1);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--cor-destaque);
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .app-bar-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--cor-fundo);
            color: var(--cor-destaque);
            border: 1px solid var(--cor-destaque);
        }

        .theme-toggle:hover {
            background-color: var(--cor-hover);
            color: var(--cor-fundo);
        }

        .search-btn, .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }

        .search-btn {
            background-color: var(--cor-fundo);
            color: var(--cor-destaque);
            border: 1px solid var(--cor-destaque);
        }

        .search-btn:hover {
            background-color: var(--cor-hover);
            color: var(--cor-fundo);
        }

        .user-avatar {
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
            font-weight: 600;
            position: relative;
        }

        .user-avatar:hover {
            background-color: var(--cor-hover);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Modal de Pesquisa */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1003;
            justify-content: center;
            align-items: flex-start;
            padding: 80px 20px 20px;
        }

        .search-modal-content {
            background-color: var(--cor-fundo);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid var(--cor-destaque);
        }

        .search-header {
            padding: 20px;
            border-bottom: 1px solid var(--cor-destaque);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            padding: 0;
            background: transparent;
            color: var(--cor-texto);
        }

        .search-input::placeholder {
            color: var(--cor-cinza);
        }

        .search-close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--cor-destaque);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .search-close:hover {
            background-color: var(--cor-hover);
            color: var(--cor-fundo);
        }

        .search-results {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
        }

        .search-result-item:hover {
            background-color: var(--cor-hover);
            color: var(--cor-fundo);
        }

        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .search-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .search-result-content {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--cor-texto);
        }

        .search-result-text {
            color: var(--cor-cinza);
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .no-results {
            text-align: center;
            color: var(--cor-cinza);
            padding: 40px 20px;
        }

        /* Modal de Perfil */
        .profile-modal {
            display: none;
            position: fixed;
            top: 70px;
            right: 16px;
            width: 320px;
            background-color: var(--cor-fundo);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.1);
            z-index: 1001;
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
            border: 1px solid var(--cor-destaque);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .profile-header {
            padding: 16px;
            background: var(--cor-destaque);
            color: var(--cor-fundo);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-info h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .profile-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .profile-details {
            padding: 16px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--cor-destaque);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-icon {
            width: 24px;
            color: var(--cor-destaque);
            margin-right: 12px;
            text-align: center;
        }

        .profile-actions {
            display: flex;
            border-top: 1px solid var(--cor-destaque);
        }

        .profile-action {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--cor-destaque);
            font-size: 0.8rem;
        }

        .profile-action:hover {
            background-color: var(--cor-hover);
            color: var(--cor-fundo);
        }

        /* Formulário de Edição */
        .edit-form {
            display: none;
            padding: 16px;
        }

        .edit-form input, .edit-form select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 12px;
            border: 1px solid var(--cor-destaque);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--cor-fundo);
            color: var(--cor-texto);
        }

        .edit-form select option {
            background: var(--cor-fundo);
            color: var(--cor-texto);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .form-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
        }

        .save-btn {
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
        }

        .cancel-btn {
            background-color: var(--cor-fundo);
            color: var(--cor-destaque);
            border: 1px solid var(--cor-destaque);
        }

        /* Conteúdo Principal */
        .main-content {
            flex: 1;
            padding: 80px 16px 70px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .post-card {
            background-color: var(--cor-fundo);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--cor-destaque);
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 12px;
            position: relative;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
        }

        .post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .post-author {
            flex: 1;
        }

        .post-author h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
            color: var(--cor-texto);
        }

        .post-meta {
            font-size: 0.8rem;
            color: var(--cor-cinza);
        }

        .post-content {
            padding: 0 16px 16px;
        }

        .post-text {
            margin-bottom: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            color: var(--cor-texto);
        }

        .post-text strong, .post-text b {
            font-weight: bold;
        }

        .post-text em, .post-text i {
            font-style: italic;
        }

        .post-text u {
            text-decoration: underline;
        }

        .post-text a {
            color: var(--cor-link);
            text-decoration: none;
        }

        .post-text a:hover {
            text-decoration: underline;
        }

        .link-preview {
            border: 1px solid var(--cor-destaque);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
            background-color: var(--cor-fundo);
        }

        .link-preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: var(--cor-cinza);
        }

        .link-preview-content {
            padding: 12px;
        }

        .link-preview-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
            color: var(--cor-texto);
        }

        .link-preview-description {
            color: var(--cor-cinza);
            font-size: 0.8rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .link-preview-url {
            color: var(--cor-link);
            font-size: 0.75rem;
            text-decoration: none;
        }

        .post-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 12px;
            max-height: 400px;
            object-fit: cover;
        }

        .image-carousel {
            position: relative;
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.3s ease;
            height: 100%;
        }

        .carousel-slide {
            min-width: 100%;
            height: 100%;
        }

        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-nav {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .carousel-dot.active {
            background-color: var(--cor-destaque);
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--cor-destaque);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .carousel-arrow:hover {
            background-color: var(--cor-hover);
        }

        .carousel-arrow.prev {
            left: 10px;
        }

        .carousel-arrow.next {
            right: 10px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            margin-top: 12px;
            border-radius: 8px;
            background-color: var(--cor-fundo);
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--cor-destaque);
            font-size: 3rem;
            opacity: 0.8;
            cursor: pointer;
            transition: opacity 0.2s;
            z-index: 2;
        }

        .video-container:hover .play-icon {
            opacity: 1;
        }

        .post-actions {
            display: flex;
            padding: 8px 16px;
            border-top: 1px solid var(--cor-destaque);
        }

        .post-action {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            color: var(--cor-destaque);
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .post-action:hover {
            background-color: var(--cor-hover);
            color: var(--cor-fundo);
        }

        .post-action.liked {
            color: #e74c3c;
        }

        .post-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .view-counter {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--cor-destaque);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .post-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1002;
            overflow-y: auto;
        }

        .post-modal-content {
            background-color: var(--cor-fundo);
            border-radius: 12px;
            max-width: 800px;
            margin: 20px auto;
            overflow: hidden;
            border: 1px solid var(--cor-destaque);
        }

        .post-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--cor-destaque);
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--cor-destaque);
        }

        .post-modal-body {
            padding: 16px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .comments-section {
            margin-top: 20px;
            border-top: 1px solid var(--cor-destaque);
            padding-top: 16px;
        }

        .comment-form {
            display: flex;
            gap: 10px;
            margin: 16px 0;
            align-items: flex-start;
        }

        .comment-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--cor-destaque);
            border-radius: 20px;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.4;
            background: var(--cor-fundo);
            color: var(--cor-texto);
        }

        .comment-input:focus {
            border-color: var(--cor-hover);
        }

        .comment-submit {
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            transition: background-color 0.2s;
            height: 40px;
        }

        .comment-submit:hover {
            background-color: var(--cor-hover);
        }

        .comment-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .comment-list {
            margin-top: 16px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-start;
        }

        .comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
            overflow: hidden;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .comment-content {
            flex: 1;
            background-color: var(--cor-fundo);
            padding: 12px 16px;
            border-radius: 16px;
            min-width: 0;
            border: 1px solid var(--cor-destaque);
        }

        .comment-author {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: var(--cor-texto);
        }

        .comment-text {
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
            margin-bottom: 6px;
            color: var(--cor-texto);
        }

        .comment-time {
            font-size: 0.75rem;
            color: var(--cor-cinza);
            opacity: 0.8;
        }

        .formatting-toolbar {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid var(--cor-destaque);
            background-color: var(--cor-fundo);
        }

        .format-btn {
            padding: 6px 10px;
            border: 1px solid var(--cor-destaque);
            background: var(--cor-fundo);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            color: var(--cor-destaque);
        }

        .format-btn:hover {
            background: var(--cor-hover);
            color: var(--cor-fundo);
        }

        .format-btn.active {
            background: var(--cor-destaque);
            color: var(--cor-fundo);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: var(--cor-fundo);
            box-shadow: 0 -1px 3px rgba(255, 215, 0, 0.1);
            display: flex;
            padding: 8px 0;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--cor-destaque);
            text-decoration: none;
            font-size: 0.7rem;
            gap: 4px;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--cor-hover);
        }

        .nav-item:hover {
            color: var(--cor-hover);
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--cor-destaque);
            color: var(--cor-fundo);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 100;
        }

        .fab:hover {
            background-color: var(--cor-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
        }

        @media (min-width: 768px) {
            .main-content {
                padding: 90px 24px 24px;
            }

            .bottom-nav {
                display: none;
            }

            .fab {
                bottom: 24px;
            }

            .comment-form {
                gap: 12px;
            }

            .comment-avatar {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--cor-cinza);
            border-radius: 50%;
            border-top-color: var(--cor-destaque);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .progress-modal {
            background: var(--cor-fundo);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--cor-destaque);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--cor-cinza);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--cor-destaque);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            margin-top: 10px;
            color: var(--cor-texto);
            font-size: 14px;
        }

        .image-upload-container {
            border: 2px dashed var(--cor-destaque);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            cursor: pointer;
            transition: border-color 0.2s;
            color: var(--cor-texto);
        }

        .image-upload-container:hover {
            border-color: var(--cor-hover);
        }

        .image-upload-container.dragover {
            border-color: var(--cor-hover);
            background-color: rgba(255, 215, 0, 0.05);
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--cor-destaque);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .upload-profile-btn {
            background: var(--cor-destaque);
            color: var(--cor-fundo);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            margin: 20px;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--cor-fundo);
            color: var(--cor-destaque);
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease;
            border: 1px solid var(--cor-destaque);
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: #27ae60;
            color: var(--cor-branco);
        }

        .toast.error {
            background: #e74c3c;
            color: var(--cor-branco);
        }
    </style>
</head>
<body>
    <!-- App Bar Superior -->
    <header class="app-bar">
        <div class="logo">
            <i class="fas fa-graduation-cap logo-icon"></i>
            <span>Folha de Inhamissa</span>
        </div>
        <div class="app-bar-actions">
            <div class="theme-toggle" id="theme-toggle">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon" style="display: none;"></i>
            </div>
            <div class="search-btn" id="search-btn">
                <i class="fas fa-search"></i>
            </div>
            <div class="user-avatar" id="user-avatar">
                <span id="avatar-initials">U</span>
            </div>
        </div>
    </header>

    <!-- Modal de Pesquisa -->
    <div class="search-modal" id="search-modal">
        <div class="search-modal-content">
            <div class="search-header">
                <i class="fas fa-search" style="color: var(--cor-destaque);"></i>
                <input type="text" class="search-input" id="search-input" placeholder="Pesquisar publicações e usuários...">
                <div class="search-close" id="search-close">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="search-results" id="search-results">
                <div class="no-results">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 12px; color: var(--cor-cinza);"></i>
                    <p>Digite algo para pesquisar...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil do Usuário Logado -->
    <div class="profile-modal" id="profile-modal">
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar">
                <span id="profile-initials">U</span>
            </div>
            <div class="profile-info">
                <h3 id="profile-name">Usuário</h3>
                <p id="profile-email">user@example.com</p>
            </div>
        </div>
        <div class="profile-details" id="profile-view">
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <p id="profile-class">Classe: Carregando...</p>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div>
                    <p id="profile-turma">Turma: Carregando...</p>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-birthday-cake"></i>
                </div>
                <div>
                    <p id="profile-birthdate">Nascimento: Carregando...</p>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <div>
                    <p id="profile-phone">Telefone: Carregando...</p>
                </div>
            </div>
        </div>
        <div class="edit-form" id="edit-form">
            <input type="text" id="edit-name" placeholder="Nome completo">
            <select id="edit-class">
                <option value="">Selecione a classe</option>
                <option value="1">1ª Classe</option>
                <option value="2">2ª Classe</option>
                <option value="3">3ª Classe</option>
                <option value="4">4ª Classe</option>
                <option value="5">5ª Classe</option>
                <option value="6">6ª Classe</option>
                <option value="7">7ª Classe</option>
                <option value="8">8ª Classe</option>
                <option value="9">9ª Classe</option>
                <option value="10">10ª Classe</option>
                <option value="11">11ª Classe</option>
                <option value="12">12ª Classe</option>
            </select>
            <select id="edit-turma">
                <option value="">Selecione a turma</option>
            </select>
            <input type="date" id="edit-birthdate">
            <input type="tel" id="edit-phone" placeholder="Número de telefone">
            <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
            <button type="button" class="upload-profile-btn" id="upload-profile-btn">Alterar Foto</button>
            <div class="form-actions">
                <button class="cancel-btn" id="cancel-edit">Cancelar</button>
                <button class="save-btn" id="save-edit">Salvar</button>
            </div>
        </div>
        <div class="profile-actions">
            <div class="profile-action" id="edit-profile">
                <i class="fas fa-edit"></i>
                <span>Editar</span>
            </div>
            <div class="profile-action" id="logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sair</span>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil de Outro Usuário -->
    <div class="profile-modal" id="other-profile-modal">
        <div class="profile-header">
            <div class="profile-avatar" id="other-profile-avatar">
                <span id="other-profile-initials">U</span>
            </div>
            <div class="profile-info">
                <h3 id="other-profile-name">Usuário</h3>
                <p id="other-profile-email">user@example.com</p>
            </div>
        </div>
        <div class="profile-details">
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <p id="other-profile-class">Classe: Carregando...</p>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div>
                    <p id="other-profile-turma">Turma: Carregando...</p>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-icon">
                    <i class="fas fa-birthday-cake"></i>
                </div>
                <div>
                    <p id="other-profile-birthdate">Nascimento: Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Publicação -->
    <div class="post-modal" id="post-modal">
        <div class="post-modal-content">
            <div class="post-modal-header">
                <h3>Publicação</h3>
                <div class="close-modal" id="close-post-modal">&times;</div>
            </div>
            <div class="post-modal-body" id="post-modal-body">
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="progress-container" id="progress-container">
        <div class="progress-modal">
            <h3>Publicando...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">0%</div>
        </div>
    </div>

    <!-- Conteúdo Principal (Feed) -->
    <main class="main-content" id="main-content">
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>
        <div class="error-message" id="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <p>Ocorreu um erro ao carregar as publicações. Tente recarregar a página.</p>
        </div>
    </main>

    <!-- Botão de Nova Publicação -->
    <div class="fab" id="new-post-btn">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item active">
            <i class="fas fa-home nav-icon"></i>
            <span>Início</span>
        </a>
        <a href="aprenda.html" class="nav-item">
            <i class="fas fa-book nav-icon"></i>
            <span>Aprenda</span>
        </a>
        <a href="horarios.html" class="nav-item">
            <i class="fas fa-calendar-alt nav-icon"></i>
            <span>Horários</span>
        </a>
        <a href="noticias.html" class="nav-item">
            <i class="fas fa-newspaper nav-icon"></i>
            <span>Notícias</span>
        </a>
    </nav>

    <!-- Toast notifications -->
    <div class="toast" id="toast"></div>

    <!-- Rodapé -->
    <footer style="text-align: center; padding: 16px; color: var(--cor-cinza); font-size: 0.8rem;">
        © 2025 Escola Secundária de Inhamissa - Xai-Xai, Gaza, Moçambique
    </footer>

    <!-- Firebase Script -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        query, 
        orderBy, 
        onSnapshot,
        doc,
        getDoc,
        updateDoc,
        setDoc,
        addDoc,
        serverTimestamp,
        increment,
        getDocs,
        where,
        limit,
        arrayUnion,
        arrayRemove,
        deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
    import { 
        getStorage, 
        ref, 
        uploadBytesResumable, 
        getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBJ8CVC2s_cb8nBdbrhPCbVbqqh6Cb9Vco",
        authDomain: "luna-bot-70962.firebaseapp.com",
        projectId: "luna-bot-70962",
        storageBucket: "luna-bot-70962.appspot.com",
        messagingSenderId: "247837414432",
        appId: "1:247837414432:web:f7f9df049b8cfdbd909845",
        measurementId: "G-8Q1L3CS37J"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elementos DOM
    const userAvatar = document.getElementById('user-avatar');
    const avatarInitials = document.getElementById('avatar-initials');
    const profileModal = document.getElementById('profile-modal');
    const otherProfileModal = document.getElementById('other-profile-modal');
    const profileInitials = document.getElementById('profile-initials');
    const profileName = document.getElementById('profile-name');
    const profileEmail = document.getElementById('profile-email');
    const profileClass = document.getElementById('profile-class');
    const profileTurma = document.getElementById('profile-turma');
    const profileBirthdate = document.getElementById('profile-birthdate');
    const profilePhone = document.getElementById('profile-phone');
    const editProfileBtn = document.getElementById('edit-profile');
    const logoutBtn = document.getElementById('logout');
    const profileView = document.getElementById('profile-view');
    const editForm = document.getElementById('edit-form');
    const editName = document.getElementById('edit-name');
    const editClass = document.getElementById('edit-class');
    const editTurma = document.getElementById('edit-turma');
    const editBirthdate = document.getElementById('edit-birthdate');
    const editPhone = document.getElementById('edit-phone');
    const cancelEdit = document.getElementById('cancel-edit');
    const saveEdit = document.getElementById('save-edit');
    const mainContent = document.getElementById('main-content');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const newPostBtn = document.getElementById('new-post-btn');
    const postModal = document.getElementById('post-modal');
    const closePostModal = document.getElementById('close-post-modal');
    const postModalBody = document.getElementById('post-modal-body');
    const profilePhotoInput = document.getElementById('profile-photo-input');
    const uploadProfileBtn = document.getElementById('upload-profile-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const toast = document.getElementById('toast');
    const searchBtn = document.getElementById('search-btn');
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const searchClose = document.getElementById('search-close');
    const searchResults = document.getElementById('search-results');
    const themeToggle = document.getElementById('theme-toggle');

    let currentUserData = null;
    let allPosts = [];
    let allUsers = [];

    // Funções de utilidade
    function showToast(message, type = 'info') {
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    async function trackPageVisit() {
        try {
            const user = auth.currentUser;
            if (!user) return;
            await addDoc(collection(db, 'uso'), {
                userId: user.uid,
                page: 'feed',
                timestamp: serverTimestamp(),
                userAgent: navigator.userAgent.substring(0, 200),
                referrer: (document.referrer || 'direct').substring(0, 100)
            });
        } catch (error) {
            console.warn('Erro ao registrar visita:', error);
        }
    }

    function detectAndFormatLinks(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }

    function processTextFormatting(text) {
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
        text = text.replace(/_(.*?)_/g, '<em>$1</em>');
        text = text.replace(/\+\+(.*?)\+\+/g, '<u>$1</u>');
        return text;
    }

    function getInitials(name) {
        if (!name) return 'U';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function getTimeAgo(date) {
        if (!date) return 'Agora mesmo';
        
        const now = new Date();
        const dateObj = date instanceof Date ? date : date.toDate ? date.toDate() : new Date(date);
        const diffInSeconds = Math.floor((now - dateObj) / 1000);
        
        if (diffInSeconds < 60) {
            return 'Agora mesmo';
        } else if (diffInSeconds < 3600) {
            const minutes = Math.floor(diffInSeconds / 60);
            return `há ${minutes} min`;
        } else if (diffInSeconds < 86400) {
            const hours = Math.floor(diffInSeconds / 3600);
            return `há ${hours} h`;
        } else if (diffInSeconds < 2592000) {
            const days = Math.floor(diffInSeconds / 86400);
            return `há ${days} dia${days !== 1 ? 's' : ''}`;
        } else {
            return dateObj.toLocaleDateString('pt-MZ');
        }
    }

    async function generateLinkPreview(url) {
        try {
            const domain = new URL(url).hostname;
            return {
                title: `Conteúdo de ${domain}`,
                description: `Visualize o conteúdo completo em ${domain}`,
                image: null,
                url: url
            };
        } catch (error) {
            console.error('Erro ao gerar preview:', error);
            return null;
        }
    }

    function createLinkPreview(preview) {
        if (!preview) return '';
        return `
            <div class="link-preview">
                ${preview.image ? `<img src="${preview.image}" class="link-preview-image" alt="Preview">` : ''}
                <div class="link-preview-content">
                    <div class="link-preview-title">${preview.title}</div>
                    <div class="link-preview-description">${preview.description}</div>
                    <a href="${preview.url}" class="link-preview-url" target="_blank" rel="noopener noreferrer">${preview.url}</a>
                </div>
            </div>
        `;
    }

    async function sharePost(postData, postId) {
        try {
            const shareUrl = `${window.location.origin}${window.location.pathname}?post=${postId}`;
            if (navigator.share) {
                await navigator.share({
                    title: `Publicação de ${postData.authorName}`,
                    text: postData.content.substring(0, 100) + (postData.content.length > 100 ? '...' : ''),
                    url: shareUrl
                });
            } else {
                await navigator.clipboard.writeText(shareUrl);
                showToast('Link da publicação copiado!', 'success');
            }
        } catch (error) {
            console.error('Erro ao compartilhar:', error);
            showToast('Erro ao compartilhar. Tente novamente.', 'error');
        }
    }

    function checkForSharedPost() {
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('post');
        if (postId) {
            loadSpecificPost(postId);
        }
    }

    async function loadSpecificPost(postId) {
        try {
            const postDoc = await getDoc(doc(db, 'posts', postId));
            if (postDoc.exists()) {
                const post = postDoc.data();
                openPostModal(post, postId);
            }
        } catch (error) {
            console.error('Erro ao carregar publicação específica:', error);
        }
    }

    async function incrementViews(postId) {
        try {
            const postRef = doc(db, 'posts', postId);
            await updateDoc(postRef, {
                views: increment(1)
            });
        } catch (error) {
            console.error('Erro ao incrementar visualizações:', error);
        }
    }

    // Funções de perfil
    function updateAvatarDisplay() {
        const initials = getInitials(currentUserData?.name);
        
        if (currentUserData?.photoURL) {
            userAvatar.innerHTML = `<img src="${currentUserData.photoURL}" alt="Foto do perfil" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                  <span style="display: none;">${initials}</span>`;
            if (profileInitials.parentElement) {
                profileInitials.parentElement.innerHTML = `<img src="${currentUserData.photoURL}" alt="Foto do perfil" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                         <span style="display: none;">${initials}</span>`;
            }
        } else {
            userAvatar.innerHTML = `<span>${initials}</span>`;
            if (profileInitials) {
                profileInitials.textContent = initials;
            }
        }
    }

    function updateProfileView() {
        if (currentUserData) {
            profileName.textContent = currentUserData.name || 'Usuário';
            profileEmail.textContent = currentUserData.email || 'Sem email';
            profileClass.textContent = currentUserData.class ? `Classe: ${currentUserData.class}ª` : 'Classe: Não informada';
            profileTurma.textContent = currentUserData.turma ? `Turma: ${currentUserData.turma}` : 'Turma: Não informada';
            
            if (currentUserData.birthdate) {
                let date;
                if (typeof currentUserData.birthdate === 'string') {
                    date = new Date(currentUserData.birthdate);
                } else if (currentUserData.birthdate.toDate) {
                    date = currentUserData.birthdate.toDate();
                } else {
                    date = new Date(currentUserData.birthdate);
                }
                profileBirthdate.textContent = `Nascimento: ${date.toLocaleDateString('pt-MZ')}`;
            } else {
                profileBirthdate.textContent = 'Nascimento: Não informado';
            }
            
            profilePhone.textContent = currentUserData.phone ? `Telefone: ${currentUserData.phone}` : 'Telefone: Não informado';
            
            // Preencher formulário de edição
            editName.value = currentUserData.name || '';
            editClass.value = currentUserData.class || '';
            
            if (currentUserData.birthdate) {
                let date;
                if (typeof currentUserData.birthdate === 'string') {
                    date = new Date(currentUserData.birthdate);
                } else if (currentUserData.birthdate.toDate) {
                    date = currentUserData.birthdate.toDate();
                } else {
                    date = new Date(currentUserData.birthdate);
                }
                editBirthdate.value = date.toISOString().split('T')[0];
            } else {
                editBirthdate.value = '';
            }
            
            editPhone.value = currentUserData.phone || '';
            
            updateTurmaOptions();
            updateAvatarDisplay();
        }
    }

    function updateTurmaOptions() {
        const selectedClass = editClass.value;
        editTurma.innerHTML = '<option value="">Selecione a turma</option>';
        
        if (selectedClass === '11' || selectedClass === '12') {
            for (let i = 1; i <= 5; i++) {
                ['A', 'B', 'C'].forEach(letter => {
                    const turma = `${letter}${i.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = turma;
                    option.textContent = `Turma ${turma}`;
                    editTurma.appendChild(option);
                });
            }
        } else {
            ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(letter => {
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = `Turma ${letter}`;
                editTurma.appendChild(option);
            });
        }
        
        // Definir valor atual se existir
        if (currentUserData && currentUserData.turma) {
            editTurma.value = currentUserData.turma;
        }
    }

    // Funções de posts
    function createImageCarousel(images) {
        if (!images || images.length === 0) return '';
        if (images.length === 1) {
            return `<img src="${images[0]}" class="post-image" alt="Imagem da publicação" onerror="this.style.display='none'">`;
        }
        
        const carouselId = `carousel-${Math.random().toString(36).substring(2, 9)}`;
        let carouselHTML = `
            <div class="image-carousel">
                <div class="carousel-container">
                    <div class="carousel-track" id="${carouselId}">
        `;
        
        images.forEach((image, index) => {
            carouselHTML += `
                <div class="carousel-slide">
                    <img src="${image}" alt="Imagem ${index + 1}" onerror="this.style.display='none'">
                </div>
            `;
        });
        
        carouselHTML += `
                    </div>
                    <button class="carousel-arrow prev" onclick="moveCarousel(-1, '${carouselId}')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-arrow next" onclick="moveCarousel(1, '${carouselId}')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="carousel-nav">
        `;
        
        images.forEach((_, index) => {
            carouselHTML += `
                <div class="carousel-dot ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index}, '${carouselId}')"></div>
            `;
        });
        
        carouselHTML += `
                </div>
            </div>
        `;
        
        return carouselHTML;
    }

    function createPostHTML(post, postId) {
        const formattedContent = processTextFormatting(detectAndFormatLinks(post.content || ''));
        const timeAgo = getTimeAgo(post.createdAt);
        const authorInitials = getInitials(post.authorName);
        const viewCount = post.views || 0;
        
        let mediaHTML = '';
        if (post.images && post.images.length > 0) {
            mediaHTML = createImageCarousel(post.images);
        } else if (post.video) {
            mediaHTML = `
                <div class="video-container">
                    <video controls>
                        <source src="${post.video}" type="video/mp4">
                        Seu navegador não suporta o elemento de vídeo.
                    </video>
                </div>
            `;
        }
        
        // Verificar se há links no conteúdo para gerar preview
        let linkPreviewHTML = '';
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const matches = post.content?.match(urlRegex);
        if (matches && matches.length > 0) {
            linkPreviewHTML = '<div class="link-preview-placeholder"></div>';
        }
        
        return `
            <div class="post-card" id="post-${postId}">
                <div class="post-header">
                    <div class="post-avatar" onclick="showUserProfile('${post.authorId}')">
                        ${post.authorPhotoURL ? 
                            `<img src="${post.authorPhotoURL}" alt="${post.authorName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                             <span style="display: none;">${authorInitials}</span>` : 
                            `<span>${authorInitials}</span>`
                        }
                    </div>
                    <div class="post-author">
                        <h4>${post.authorName || 'Usuário'}</h4>
                        <div class="post-meta">${timeAgo}</div>
                    </div>
                    ${viewCount > 0 ? `
                        <div class="view-counter">
                            <i class="fas fa-eye"></i>
                            ${viewCount}
                        </div>
                    ` : ''}
                </div>
                <div class="post-content">
                    <div class="post-text">${formattedContent}</div>
                    ${linkPreviewHTML}
                    ${mediaHTML}
                </div>
                <div class="post-actions">
                    <div class="post-action like-btn" data-post-id="${postId}">
                        <i class="fas fa-heart"></i>
                        <span>${post.likes || 0}</span>
                    </div>
                    <div class="post-action comment-btn" data-post-id="${postId}">
                        <i class="fas fa-comment"></i>
                        <span>${post.comments || 0}</span>
                    </div>
                    <div class="post-action share-btn" data-post-id="${postId}">
                        <i class="fas fa-share-alt"></i>
                        <span>Partilhar</span>
                    </div>
                </div>
            </div>
        `;
    }

    // Funções de pesquisa
    function showNoResults(message = 'Digite algo para pesquisar...') {
        searchResults.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 12px; color: var(--cor-cinza);"></i>
                <p>${message}</p>
            </div>
        `;
    }

    function performSearch(query) {
        const lowercaseQuery = query.toLowerCase();
        const results = [];
        
        allPosts.forEach(post => {
            if ((post.content && post.content.toLowerCase().includes(lowercaseQuery)) ||
                (post.authorName && post.authorName.toLowerCase().includes(lowercaseQuery))) {
                results.push({
                    type: 'post',
                    data: post,
                    relevance: calculateRelevance(post, lowercaseQuery)
                });
            }
        });
        
        allUsers.forEach(user => {
            if ((user.name && user.name.toLowerCase().includes(lowercaseQuery)) ||
                (user.email && user.email.toLowerCase().includes(lowercaseQuery))) {
                results.push({
                    type: 'user',
                    data: user,
                    relevance: calculateUserRelevance(user, lowercaseQuery)
                });
            }
        });
        
        results.sort((a, b) => b.relevance - a.relevance);
        displaySearchResults(results, query);
    }

    function calculateRelevance(post, query) {
        let score = 0;
        const content = (post.content || '').toLowerCase();
        const author = (post.authorName || '').toLowerCase();
        
        if (author.includes(query)) score += 10;
        const contentMatches = (content.match(new RegExp(query, 'gi')) || []).length;
        score += contentMatches * 2;
        score += (post.likes || 0) * 0.1;
        score += (post.comments || 0) * 0.2;
        
        return score;
    }

    function calculateUserRelevance(user, query) {
        let score = 0;
        const name = (user.name || '').toLowerCase();
        const email = (user.email || '').toLowerCase();
        
        if (name.startsWith(query)) score += 15;
        else if (name.includes(query)) score += 10;
        if (email.includes(query)) score += 5;
        
        return score;
    }

    function displaySearchResults(results, query) {
        if (results.length === 0) {
            showNoResults(`Nenhum resultado encontrado para "${query}"`);
            return;
        }
        
        let html = '';
        results.slice(0, 20).forEach(result => {
            if (result.type === 'post') {
                const post = result.data;
                const preview = (post.content || '').substring(0, 100);
                const authorInitials = getInitials(post.authorName);
                
                html += `
                    <div class="search-result-item" onclick="openPostFromSearch('${post.id}')">
                        <div class="search-result-avatar">
                            ${post.authorPhotoURL ? 
                                `<img src="${post.authorPhotoURL}" alt="${post.authorName}">` : 
                                authorInitials
                            }
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-name">${post.authorName || 'Usuário'}</div>
                            <div class="search-result-text">${preview}${preview.length >= 100 ? '...' : ''}</div>
                        </div>
                    </div>
                `;
            } else if (result.type === 'user') {
                const user = result.data;
                const userInitials = getInitials(user.name);
                
                html += `
                    <div class="search-result-item" onclick="showUserProfile('${user.uid}')">
                        <div class="search-result-avatar">
                            ${user.photoURL ? 
                                `<img src="${user.photoURL}" alt="${user.name}">` : 
                                userInitials
                            }
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-name">${user.name || 'Usuário'}</div>
                            <div class="search-result-text">${user.email || ''}</div>
                        </div>
                    </div>
                `;
            }
        });
        
        searchResults.innerHTML = html;
    }

    // Funções globais
    window.openPostFromSearch = function(postId) {
        const post = allPosts.find(p => p.id === postId);
        if (post) {
            searchModal.style.display = 'none';
            openPostModal(post.data, postId);
        }
    };

    window.showUserProfile = async function(userId) {
        try {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (!userDoc.exists()) {
                showToast('Usuário não encontrado', 'error');
                return;
            }
            
            const userData = userDoc.data();
            const otherProfileAvatar = document.getElementById('other-profile-avatar');
            const otherProfileInitials = document.getElementById('other-profile-initials');
            const otherProfileName = document.getElementById('other-profile-name');
            const otherProfileEmail = document.getElementById('other-profile-email');
            const otherProfileClass = document.getElementById('other-profile-class');
            const otherProfileTurma = document.getElementById('other-profile-turma');
            const otherProfileBirthdate = document.getElementById('other-profile-birthdate');
            
            const initials = getInitials(userData.name);
            
            if (userData.photoURL) {
                otherProfileAvatar.innerHTML = `<img src="${userData.photoURL}" alt="Foto do perfil" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                              <span style="display: none;">${initials}</span>`;
            } else {
                otherProfileAvatar.innerHTML = `<span>${initials}</span>`;
            }
            
            otherProfileName.textContent = userData.name || 'Usuário';
            otherProfileEmail.textContent = userData.email || 'Sem email';
            otherProfileClass.textContent = userData.class ? `Classe: ${userData.class}ª` : 'Classe: Não informada';
            otherProfileTurma.textContent = userData.turma ? `Turma: ${userData.turma}` : 'Turma: Não informada';
            
            if (userData.birthdate) {
                let date = typeof userData.birthdate === 'string' ? 
                    new Date(userData.birthdate) : 
                    userData.birthdate.toDate ? userData.birthdate.toDate() : new Date(userData.birthdate);
                otherProfileBirthdate.textContent = `Nascimento: ${date.toLocaleDateString('pt-MZ')}`;
            } else {
                otherProfileBirthdate.textContent = 'Nascimento: Não informado';
            }
            
            searchModal.style.display = 'none';
            otherProfileModal.style.display = 'block';
        } catch (error) {
            console.error('Erro ao carregar perfil do usuário:', error);
            showToast('Erro ao carregar perfil', 'error');
        }
    };

    window.moveCarousel = function(direction, carouselId) {
        const track = document.getElementById(carouselId);
        if (!track) return;
        
        const slides = track.querySelectorAll('.carousel-slide');
        const totalSlides = slides.length;
        let currentSlide = parseInt(track.dataset.currentSlide || 0);
        
        currentSlide += direction;
        if (currentSlide < 0) currentSlide = totalSlides - 1;
        if (currentSlide >= totalSlides) currentSlide = 0;
        
        track.style.transform = `translateX(-${currentSlide * 100}%)`;
        track.dataset.currentSlide = currentSlide;
        
        // Atualizar dots
        const dots = track.parentElement.querySelectorAll('.carousel-dot');
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === currentSlide);
        });
    };

    window.goToSlide = function(slideIndex, carouselId) {
        const track = document.getElementById(carouselId);
        if (!track) return;
        
        const slides = track.querySelectorAll('.carousel-slide');
        if (slideIndex >= 0 && slideIndex < slides.length) {
            track.style.transform = `translateX(-${slideIndex * 100}%)`;
            track.dataset.currentSlide = slideIndex;
            
            // Atualizar dots
            const dots = track.parentElement.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === slideIndex);
            });
        }
    };

    // Event Listeners
    userAvatar.addEventListener('click', () => {
        profileModal.style.display = profileModal.style.display === 'block' ? 'none' : 'block';
        otherProfileModal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
        if (!userAvatar.contains(e.target) && !profileModal.contains(e.target)) {
            profileModal.style.display = 'none';
        }
        if (e.target === otherProfileModal) {
            otherProfileModal.style.display = 'none';
        }
        if (e.target === searchModal) {
            searchModal.style.display = 'none';
            searchInput.value = '';
            showNoResults();
        }
    });

    closePostModal.addEventListener('click', () => {
        postModal.style.display = 'none';
    });

    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showToast('Logout realizado com sucesso!', 'success');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        } catch (error) {
            console.error('Erro ao sair:', error);
            showToast('Erro ao fazer logout. Tente novamente.', 'error');
        }
    });

    editProfileBtn.addEventListener('click', () => {
        profileView.style.display = 'none';
        editForm.style.display = 'block';
    });

    cancelEdit.addEventListener('click', () => {
        profileView.style.display = 'block';
        editForm.style.display = 'none';
    });

    uploadProfileBtn.addEventListener('click', () => {
        profilePhotoInput.click();
    });

    profilePhotoInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            progressContainer.style.display = 'flex';
            const photoRef = ref(storage, `profile-photos/${user.uid}`);
            const uploadTask = uploadBytesResumable(photoRef, file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                },
                (error) => {
                    console.error('Erro no upload:', error);
                    progressContainer.style.display = 'none';
                    showToast('Erro ao fazer upload da foto', 'error');
                },
                async () => {
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        
                        await updateDoc(doc(db, 'users', user.uid), {
                            photoURL: downloadURL,
                            updatedAt: serverTimestamp()
                        });
                        
                        currentUserData.photoURL = downloadURL;
                        updateAvatarDisplay();
                        
                        progressContainer.style.display = 'none';
                        showToast('Foto de perfil atualizada!', 'success');
                    } catch (error) {
                        console.error('Erro ao salvar URL da foto:', error);
                        progressContainer.style.display = 'none';
                        showToast('Erro ao salvar foto', 'error');
                    }
                }
            );
        } catch (error) {
            console.error('Erro ao fazer upload da foto:', error);
            progressContainer.style.display = 'none';
            showToast('Erro ao fazer upload da foto', 'error');
        }
    });

    saveEdit.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            const updates = {
                name: editName.value,
                class: editClass.value,
                turma: editTurma.value,
                birthdate: editBirthdate.value,
                phone: editPhone.value,
                updatedAt: serverTimestamp()
            };
            
            await updateDoc(doc(db, 'users', user.uid), updates);
            
            // Atualizar dados locais
            Object.assign(currentUserData, updates);
            updateProfileView();
            
            profileView.style.display = 'block';
            editForm.style.display = 'none';
            
            showToast('Perfil atualizado com sucesso!', 'success');
        } catch (error) {
            console.error('Erro ao atualizar perfil:', error);
            showToast('Erro ao atualizar perfil', 'error');
        }
    });

    editClass.addEventListener('change', updateTurmaOptions);

    // Tema
    function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === 'light') {
            root.style.setProperty('--cor-fundo', '#FFFFFF');
            root.style.setProperty('--cor-texto', '#000000');
            root.style.setProperty('--cor-cinza', '#6B7280');
            root.style.setProperty('--cor-branco', '#F3F4F6');
            themeToggle.querySelector('.fa-sun').style.display = 'none';
            themeToggle.querySelector('.fa-moon').style.display = 'inline';
        } else {
            root.style.setProperty('--cor-fundo', '#000000');
            root.style.setProperty('--cor-texto', '#FFFFFF');
            root.style.setProperty('--cor-cinza', '#6B7280');
            root.style.setProperty('--cor-branco', '#FFFFFF');
            themeToggle.querySelector('.fa-sun').style.display = 'inline';
            themeToggle.querySelector('.fa-moon').style.display = 'none';
        }
    }

    themeToggle.addEventListener('click', async () => {
        const currentTheme = document.documentElement.style.getPropertyValue('--cor-fundo') === '#FFFFFF' ? 'light' : 'dark';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
        
        try {
            if (auth.currentUser) {
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    theme: newTheme,
                    updatedAt: serverTimestamp()
                });
                currentUserData.theme = newTheme;
            }
        } catch (error) {
            console.error('Erro ao salvar preferência de tema:', error);
        }
    });

    // Nova publicação
    newPostBtn.addEventListener('click', () => {
        showPublishModal();
    });

    function showPublishModal() {
        const publishModal = document.createElement('div');
        publishModal.className = 'post-modal';
        publishModal.innerHTML = `
            <div class="post-modal-content">
                <div class="post-modal-header">
                    <h3>Nova Publicação</h3>
                    <div class="close-modal" onclick="this.closest('.post-modal').remove()">&times;</div>
                </div>
                <div class="post-modal-body">
                    <div class="formatting-toolbar">
                        <button type="button" class="format-btn" data-format="bold" title="Negrito">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="format-btn" data-format="italic" title="Itálico">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="format-btn" data-format="underline" title="Sublinhado">
                            <i class="fas fa-underline"></i>
                        </button>
                    </div>
                    <form id="publish-form">
                        <textarea id="post-content" placeholder="O que você está pensando? Use **texto** para negrito, *texto* para itálico, ++texto++ para sublinhado" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--cor-destaque); border-radius: 8px; resize: vertical; font-family: inherit; border-top: none; background: var(--cor-fundo); color: var(--cor-texto);"></textarea>
                        <div style="margin: 16px 0;">
                            <input type="file" id="media-input" accept="image/*" multiple style="display: none;">
                            <button type="button" onclick="document.getElementById('media-input').click()" style="background: var(--cor-fundo); border: 1px solid var(--cor-destaque); padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px; color: var(--cor-destaque);">
                                <i class="fas fa-image"></i> Adicionar Fotos (Max: 8)
                            </button>
                            <input type="file" id="video-input" accept="video/*" style="display: none;">
                            <button type="button" onclick="document.getElementById('video-input').click()" style="background: var(--cor-fundo); border: 1px solid var(--cor-destaque); padding: 8px 16px; border-radius: 6px; cursor: pointer; color: var(--cor-destaque);">
                                <i class="fas fa-video"></i> Adicionar Vídeo
                            </button>
                            <div id="media-preview" style="margin-top: 12px;"></div>
                        </div>
                        <button type="submit" style="background: var(--cor-destaque); color: var(--cor-fundo); border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; width: 100%;">Publicar</button>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(publishModal);
        publishModal.style.display = 'block';
        
        let selectedImages = [];
        let selectedVideo = null;
        
        const formatBtns = publishModal.querySelectorAll('.format-btn');
        const contentTextarea = publishModal.querySelector('#post-content');
        const mediaInput = publishModal.querySelector('#media-input');
        const videoInput = publishModal.querySelector('#video-input');
        const mediaPreview = publishModal.querySelector('#media-preview');
        const form = publishModal.querySelector('#publish-form');
        
        // Formatação de texto
        formatBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const format = btn.dataset.format;
                const start = contentTextarea.selectionStart;
                const end = contentTextarea.selectionEnd;
                const selectedText = contentTextarea.value.substring(start, end);
                let formattedText = '';
                
                switch(format) {
                    case 'bold':
                        formattedText = `**${selectedText}**`;
                        break;
                    case 'italic':
                        formattedText = `*${selectedText}*`;
                        break;
                    case 'underline':
                        formattedText = `++${selectedText}++`;
                        break;
                }
                
                const newValue = contentTextarea.value.substring(0, start) + formattedText + contentTextarea.value.substring(end);
                contentTextarea.value = newValue;
                contentTextarea.focus();
                contentTextarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
            });
        });
        
        // Upload de imagens
        mediaInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files).slice(0, 8 - selectedImages.length);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedImages.push(event.target.result);
                        updateMediaPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
        
        // Upload de vídeo
        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('video/')) {
                selectedVideo = URL.createObjectURL(file);
                updateMediaPreview();
            }
        });
        
        function updateMediaPreview() {
            mediaPreview.innerHTML = '';
            
            if (selectedVideo) {
                const videoPreview = document.createElement('div');
                videoPreview.style.position = 'relative';
                videoPreview.style.marginBottom = '10px';
                videoPreview.innerHTML = `
                    <video src="${selectedVideo}" style="width: 100%; max-height: 200px; border-radius: 8px;"></video>
                    <button type="button" onclick="removeVideo()" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: var(--cor-destaque); border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                mediaPreview.appendChild(videoPreview);
            }
            
            if (selectedImages.length > 0) {
                const imagesContainer = document.createElement('div');
                imagesContainer.style.display = 'grid';
                imagesContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                imagesContainer.style.gap = '10px';
                imagesContainer.style.marginTop = '10px';
                
                selectedImages.forEach((image, index) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.position = 'relative';
                    imgWrapper.innerHTML = `
                        <img src="${image}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px;">
                        <button type="button" onclick="removeImage(${index})" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: var(--cor-destaque); border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    imagesContainer.appendChild(imgWrapper);
                });
                
                mediaPreview.appendChild(imagesContainer);
            }
        }
        
        window.removeImage = function(index) {
            selectedImages.splice(index, 1);
            updateMediaPreview();
        };
        
        window.removeVideo = function() {
            selectedVideo = null;
            updateMediaPreview();
        };
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = contentTextarea.value.trim();
            
            if (!content && selectedImages.length === 0 && !selectedVideo) {
                showToast('Adicione texto, imagem ou vídeo para publicar', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showToast('Você precisa estar logado para publicar', 'error');
                return;
            }
            
            try {
                publishModal.querySelector('button[type="submit"]').disabled = true;
                progressContainer.style.display = 'flex';
                
                // Upload de mídia
                let mediaUrls = [];
                let videoUrl = null;
                
                // Upload de imagens
                if (selectedImages.length > 0) {
                    for (let i = 0; i < selectedImages.length; i++) {
                        const imageData = selectedImages[i];
                        const imageRef = ref(storage, `posts/${user.uid}/${Date.now()}_${i}.jpg`);
                        const response = await fetch(imageData);
                        const blob = await response.blob();
                        const snapshot = await uploadBytesResumable(imageRef, blob);
                        const url = await getDownloadURL(snapshot.ref);
                        mediaUrls.push(url);
                        progressFill.style.width = ((i + 1) / (selectedImages.length + (selectedVideo ? 1 : 0)) * 50) + '%';
                        progressText.textContent = Math.round(((i + 1) / (selectedImages.length + (selectedVideo ? 1 : 0)) * 50)) + '%';
                    }
                }
                
                // Upload de vídeo
                if (selectedVideo) {
                    const videoRef = ref(storage, `posts/${user.uid}/${Date.now()}_video.mp4`);
                    const response = await fetch(selectedVideo);
                    const blob = await response.blob();
                    const snapshot = await uploadBytesResumable(videoRef, blob);
                    videoUrl = await getDownloadURL(snapshot.ref);
                    progressFill.style.width = '75%';
                    progressText.textContent = '75%';
                }
                
                // Criar post no Firestore
                const postData = {
                    authorId: user.uid,
                    authorName: currentUserData?.name || user.displayName || 'Usuário',
                    authorPhotoURL: currentUserData?.photoURL || '',
                    content: content,
                    images: mediaUrls,
                    video: videoUrl,
                    likes: 0,
                    comments: 0,
                    views: 0,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                await addDoc(collection(db, 'posts'), postData);
                
                progressFill.style.width = '100%';
                progressText.textContent = '100%';
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    publishModal.remove();
                    showToast('Publicação criada com sucesso!', 'success');
                    loadPosts(); // Recarregar posts
                }, 500);
                
            } catch (error) {
                console.error('Erro ao publicar:', error);
                progressContainer.style.display = 'none';
                publishModal.querySelector('button[type="submit"]').disabled = false;
                showToast('Erro ao publicar. Tente novamente.', 'error');
            }
        });
    }

    // Carregar posts
    function loadPosts() {
        loading.style.display = 'flex';
        errorMessage.style.display = 'none';
        
        const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
        
        onSnapshot(postsQuery, 
            (snapshot) => {
                allPosts = [];
                let postsHTML = '';
                
                snapshot.forEach((doc) => {
                    const post = doc.data();
                    allPosts.push({ id: doc.id, data: post, ...post });
                });
                
                if (allPosts.length === 0) {
                    postsHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--cor-cinza);">
                            <i class="fas fa-newspaper" style="font-size: 3rem; margin-bottom: 16px;"></i>
                            <h3>Nenhuma publicação ainda</h3>
                            <p>Seja o primeiro a compartilhar algo!</p>
                        </div>
                    `;
                } else {
                    allPosts.forEach((post) => {
                        postsHTML += createPostHTML(post.data, post.id);
                    });
                }
                
                loading.style.display = 'none';
                mainContent.innerHTML = postsHTML;
                
                // Adicionar event listeners para interações
                addPostEventListeners();
                
                // Carregar previews de links
                loadLinkPreviews();
            },
            (error) => {
                console.error('Erro ao carregar posts:', error);
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        );
    }

    async function loadLinkPreviews() {
        const linkPreviews = document.querySelectorAll('.link-preview-placeholder');
        linkPreviews.forEach(async (previewElement) => {
            const postCard = previewElement.closest('.post-card');
            const postId = postCard?.id.replace('post-', '');
            if (!postId) return;
            
            const post = allPosts.find(p => p.id === postId);
            if (!post || !post.content) return;
            
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = post.content.match(urlRegex);
            if (matches && matches.length > 0) {
                const preview = await generateLinkPreview(matches[0]);
                if (preview) {
                    previewElement.innerHTML = createLinkPreview(preview);
                }
            }
        });
    }

    function addPostEventListeners() {
        // Like buttons
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const postId = btn.dataset.postId;
                const user = auth.currentUser;
                if (!user) {
                    showToast('Faça login para curtir publicações', 'error');
                    return;
                }
                
                try {
                    const likeRef = doc(db, 'posts', postId, 'likes', user.uid);
                    const likeDoc = await getDoc(likeRef);
                    const postRef = doc(db, 'posts', postId);
                    
                    if (likeDoc.exists()) {
                        // Remover like
                        await updateDoc(postRef, {
                            likes: increment(-1)
                        });
                        await deleteDoc(likeRef);
                        btn.classList.remove('liked');
                        btn.querySelector('span').textContent = parseInt(btn.querySelector('span').textContent) - 1;
                    } else {
                        // Adicionar like
                        await updateDoc(postRef, {
                            likes: increment(1)
                        });
                        await setDoc(likeRef, {
                            userId: user.uid,
                            timestamp: serverTimestamp()
                        });
                        btn.classList.add('liked');
                        btn.querySelector('span').textContent = parseInt(btn.querySelector('span').textContent) + 1;
                    }
                } catch (error) {
                    console.error('Erro ao curtir:', error);
                    showToast('Erro ao curtir publicação', 'error');
                }
            });
        });
        
        // Comment buttons
        document.querySelectorAll('.comment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const postId = btn.dataset.postId;
                const post = allPosts.find(p => p.id === postId);
                if (post) {
                    openPostModal(post.data, postId);
                }
            });
        });
        
        // Share buttons
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const postId = btn.dataset.postId;
                const post = allPosts.find(p => p.id === postId);
                if (post) {
                    sharePost(post.data, postId);
                }
            });
        });
        
        // Post click to open modal
        document.querySelectorAll('.post-card').forEach(card => {
            const postId = card.id.replace('post-', '');
            card.addEventListener('click', (e) => {
                if (e.target.closest('.post-actions') || e.target.tagName === 'A') {
                    return;
                }
                const post = allPosts.find(p => p.id === postId);
                if (post) {
                    openPostModal(post.data, postId);
                }
            });
        });
    }

    // Abrir modal de post
    async function openPostModal(post, postId) {
        try {
            // Incrementar visualizações
            await incrementViews(postId);
            
            const formattedContent = processTextFormatting(detectAndFormatLinks(post.content || ''));
            const timeAgo = getTimeAgo(post.createdAt);
            const authorInitials = getInitials(post.authorName);
            
            let mediaHTML = '';
            if (post.images && post.images.length > 0) {
                mediaHTML = createImageCarousel(post.images);
            } else if (post.video) {
                mediaHTML = `
                    <div class="video-container">
                        <video controls>
                            <source src="${post.video}" type="video/mp4">
                            Seu navegador não suporta o elemento de vídeo.
                        </video>
                    </div>
                `;
            }
            
            let linkPreviewHTML = '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = post.content?.match(urlRegex);
            if (matches && matches.length > 0) {
                const preview = await generateLinkPreview(matches[0]);
                if (preview) {
                    linkPreviewHTML = createLinkPreview(preview);
                }
            }
            
            postModalBody.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar" onclick="showUserProfile('${post.authorId}')">
                        ${post.authorPhotoURL ? 
                            `<img src="${post.authorPhotoURL}" alt="${post.authorName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                             <span style="display: none;">${authorInitials}</span>` : 
                            `<span>${authorInitials}</span>`
                        }
                    </div>
                    <div class="post-author">
                        <h4>${post.authorName || 'Usuário'}</h4>
                        <div class="post-meta">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">
                    <div class="post-text">${formattedContent}</div>
                    ${linkPreviewHTML}
                    ${mediaHTML}
                </div>
                <div class="comments-section">
                    <h4>Comentários (${post.comments || 0})</h4>
                    <div class="comment-form">
                        <div class="post-avatar" style="width: 36px; height: 36px;">
                            ${currentUserData?.photoURL ? 
                                `<img src="${currentUserData.photoURL}" alt="${currentUserData.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <span style="display: none;">${getInitials(currentUserData.name)}</span>` : 
                                `<span>${getInitials(currentUserData?.name)}</span>`
                            }
                        </div>
                        <textarea class="comment-input" id="comment-input-${postId}" placeholder="Escreva um comentário..."></textarea>
                        <button class="comment-submit" id="comment-submit-${postId}">Comentar</button>
                    </div>
                    <div class="comment-list" id="comment-list-${postId}">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            `;
            
            postModal.style.display = 'block';
            
            // Carregar comentários
            loadComments(postId);
            
            // Adicionar event listener para enviar comentário
            const commentInput = document.getElementById(`comment-input-${postId}`);
            const commentSubmit = document.getElementById(`comment-submit-${postId}`);
            
            commentInput.addEventListener('input', () => {
                commentSubmit.disabled = commentInput.value.trim() === '';
            });
            
            commentSubmit.addEventListener('click', async () => {
                const content = commentInput.value.trim();
                if (!content) return;
                
                const user = auth.currentUser;
                if (!user) {
                    showToast('Faça login para comentar', 'error');
                    return;
                }
                
                try {
                    commentSubmit.disabled = true;
                    
                    // Adicionar comentário
                    await addDoc(collection(db, 'posts', postId, 'comments'), {
                        authorId: user.uid,
                        authorName: currentUserData?.name || user.displayName || 'Usuário',
                        authorPhotoURL: currentUserData?.photoURL || '',
                        content: content,
                        createdAt: serverTimestamp()
                    });
                    
                    // Atualizar contador de comentários
                    await updateDoc(doc(db, 'posts', postId), {
                        comments: increment(1),
                        updatedAt: serverTimestamp()
                    });
                    
                    commentInput.value = '';
                    commentSubmit.disabled = true;
                    
                    // Recarregar comentários
                    loadComments(postId);
                    
                    showToast('Comentário adicionado!', 'success');
                } catch (error) {
                    console.error('Erro ao adicionar comentário:', error);
                    commentSubmit.disabled = false;
                    showToast('Erro ao adicionar comentário', 'error');
                }
            });
            
        } catch (error) {
            console.error('Erro ao abrir publicação:', error);
            showToast('Erro ao carregar publicação', 'error');
        }
    }

    // Carregar comentários
    async function loadComments(postId) {
        try {
            const commentsQuery = query(
                collection(db, 'posts', postId, 'comments'), 
                orderBy('createdAt', 'asc')
            );
            
            const commentsSnapshot = await getDocs(commentsQuery);
            const commentsList = document.getElementById(`comment-list-${postId}`);
            
            if (commentsSnapshot.empty) {
                commentsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--cor-cinza);">
                        <p>Nenhum comentário ainda. Seja o primeiro a comentar!</p>
                    </div>
                `;
                return;
            }
            
            let commentsHTML = '';
            commentsSnapshot.forEach(doc => {
                const comment = doc.data();
                const timeAgo = getTimeAgo(comment.createdAt);
                const authorInitials = getInitials(comment.authorName);
                
                commentsHTML += `
                    <div class="comment-item">
                        <div class="comment-avatar">
                            ${comment.authorPhotoURL ? 
                                `<img src="${comment.authorPhotoURL}" alt="${comment.authorName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <span style="display: none;">${authorInitials}</span>` : 
                                `<span>${authorInitials}</span>`
                            }
                        </div>
                        <div class="comment-content">
                            <div class="comment-author">${comment.authorName || 'Usuário'}</div>
                            <div class="comment-text">${processTextFormatting(detectAndFormatLinks(comment.content || ''))}</div>
                            <div class="comment-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            });
            
            commentsList.innerHTML = commentsHTML;
        } catch (error) {
            console.error('Erro ao carregar comentários:', error);
            document.getElementById(`comment-list-${postId}`).innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--cor-cinza);">
                    <p>Erro ao carregar comentários.</p>
                </div>
            `;
        }
    }

    // Pesquisa
    searchBtn.addEventListener('click', () => {
        searchModal.style.display = 'flex';
        searchInput.focus();
    });

    searchClose.addEventListener('click', () => {
        searchModal.style.display = 'none';
        searchInput.value = '';
        showNoResults();
    });

    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        if (query.length === 0) {
            showNoResults();
            return;
        }
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });

    // Inicialização
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                // Carregar dados do usuário
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    if (currentUserData.theme) {
                        applyTheme(currentUserData.theme);
                    }
                } else {
                    // Criar documento do usuário se não existir
                    currentUserData = {
                        uid: user.uid,
                        name: user.displayName || 'Usuário',
                        email: user.email,
                        role: 'student',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    await setDoc(doc(db, 'users', user.uid), currentUserData);
                }
                
                updateProfileView();
                loadPosts();
                trackPageVisit();
                
                // Carregar todos os usuários para pesquisa
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({ uid: doc.id, ...doc.data() });
                });
                
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    // Verificar se há uma publicação específica para carregar (compartilhada)
    checkForSharedPost();

</script>
</body>
</html>